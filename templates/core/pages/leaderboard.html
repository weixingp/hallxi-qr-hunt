{% extends "core/base.html" %}
{% load static %}
{% load thumbnail %}
{% load i18n %}
{% block head_title %}{% trans "Leaderboard | HALL XI BoB" %}{% endblock %}
{% block extra_head %}
{% endblock %}
{% block body %}
    <!-- App Header -->
    <div class="appHeader bg-primary text-light">
        <div class="left">
            <a href="/" class="headerButton goBack">
                <ion-icon name="home-outline"></ion-icon>
            </a>
        </div>
        <div class="right">
            <a href="" onClick="window.location.reload()" class="headerButton">
                <ion-icon name="reload-outline"></ion-icon>
            </a>
        </div>
        <div class="pageTitle">
            Leaderboard
        </div>
    </div>
    <!-- * App Header -->

    <!-- App Capsule -->
    <div id="appCapsule" class="full-height">

        <div class="section mt-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-start align-items-center">
                        <div class="avatar mr-3">
                            <img src="{{ user.socialaccount_set.all.0.get_avatar_url }}" alt="avatar" class="imaged rounded shadow" style="width:64px">
                        </div>
                        <div>
                            <h3 class="mb-1 text-muted">{{ user.profile.fullname }}</h3>
                            <h3>{{ user_points }} Points</h3>
                        </div>
                        <div class="text-center" style="margin-left: auto;">Rank <br />{{ user_rank }}</div>
                    </div>
                </div>

            </div>
        </div>

        <div class="section mt-5">
            <div class="row">
                <div class="card mr-1 mt-3 col">
                    <div class="card-body text-center px-0">
                        <div class="avatar" style="margin-top: -3em">
                            <img src="{{ top_3.1.profile.user.socialaccount_set.all.0.get_avatar_url }}" alt="avatar" class="imaged rounded shadow" style="width:58px">
                        </div>
                        <h3 class="mt-1 mb-1">
                            <div class="chip chip-success">
                                <span class="chip-label">2</span>
                            </div>
                        </h3>
                        <h5 class="mb-1">{{ top_3.1.profile.fullname }}</h5>
                        <h4 class="mb-0">{{ top_3.1.total_points }}</h4>
                        <h5 class="text-muted mb-1">points</h5>
                    </div>
                    <div style="bottom:3px; position:absolute; left:6px;">
                        <small>Block {{ top_3.1.profile.block.name }}</small>
                    </div>
                </div>
                <div class="card mr-1 col">
                    <div class="card-body text-center px-0">
                        <div class="avatar" style="margin-top: -3em">
                            <img src="{{ top_3.0.profile.user.socialaccount_set.all.0.get_avatar_url }}" alt="avatar" class="imaged rounded shadow" style="width:58px">
                        </div>
                        <h3 class="mt-1 mb-1">
                            <div class="chip chip-info">
                                <span class="chip-label">1</span>
                            </div>
                        </h3>
                        <h5 class="mb-1">{{ top_3.0.profile.fullname }}</h5>
                        <h4 class="mb-0">{{ top_3.0.total_points }}</h4>
                        <h5 class="text-muted mb-1">points</h5>
                    </div>
                    <div style="bottom:3px; position:absolute; left:6px;">
                        <small>Block {{ top_3.0.profile.block.name }}</small>
                    </div>
                </div>
                <div class="card mt-3 col">
                    <div class="card-body text-center px-0">
                        <div class="avatar" style="margin-top: -3em">
                            <img src="{{ top_3.2.profile.user.socialaccount_set.all.0.get_avatar_url }}" alt="avatar" class="imaged rounded shadow" style="width:58px">
                        </div>
                        <h3 class="mt-1 mb-1">
                            <div class="chip chip-warning">
                                <span class="chip-label">3</span>
                            </div>
                        </h3>
                        <h5 class="mb-1">{{ top_3.2.profile.fullname }}</h5>
                        <h4 class="mb-0">{{ top_3.2.total_points }}</h4>
                        <h5 class="text-muted mb-1">points</h5>
                    </div>
                    <div style="bottom:3px; position:absolute; left:6px;">
                        <small>Block {{ top_3.2.profile.block.name }}</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="section mt-2 full">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                    <tr>
                        <th scope="col" style="width:10%">Rank</th>
                        <th scope="col" style="width:80%">Player</th>
                        <th scope="col">Points</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for item in ranking %}
                        <tr>
                            <td class="align-middle text-center">
                                <span style="font-size:18px">{{ item.rank }}</span>
                            </td>
                            <td class="align-middle">
                                <div class="d-flex justify-content-start align-items-center">
                                    <div class="avatar pr-2">
                                        <img src="{{ item.profile.user.socialaccount_set.all.0.get_avatar_url }}" alt="avatar" class="imaged rounded" style="width:42px">
                                    </div>
                                    <div>
                                        <h4 class="mb-0">{{ item.profile.fullname }}</h4>
                                        <div class="text-muted">{{ item.profile.block.name }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="align-middle text-center">
                                <span style="font-size:18px"><strong>{{ item.total_points }}</strong></span>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- * App Capsule -->
    <!-- Error dialogue -->
    <div class="modal fade dialogbox" id="error-dialogue" data-backdrop="static" tabindex="-1" aria-hidden="true" style="display: none;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-icon text-danger">
                    <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                </div>
                <div class="modal-header">
                    <h5 class="modal-title">Error</h5>
                </div>
                <div class="modal-body" id="error-dialogue-message">
                    This is a dialog message
                </div>
                <div class="modal-footer">
                    <div class="btn-inline">
                        <a href="/" class="btn">HOME</a>
                        <a href="/lootbox" class="btn btn-text-primary">RETRY</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- * Error dialogue -->
{%  endblock %}
{% block extra_script %}
    <script>
        var getGif = function() {
            var gif = [];
            $('img').each(function() {
                var data = $(this).data('alt');
                gif.push(data);
            });
            return gif;
        }
        var gif = getGif();

        // Preload all the GIF.
        var image = [];

        $.each(gif, function(index) {
            image[index]     = new Image();
            image[index].src = gif[index];
        });

        $('#open-box').one('click', function() {
            $(this).html(`<div class="spinner-border text-danger" role="status" style="position: relative;top: 0.8em;"></div>`);

            setTimeout(function(){
                $('.card1-middle').slideToggle();
                $("#total-item-text").fadeIn( "slow", function() {});
                $('.card1-title').html(`<a href='/inventory'>View in inventory</a>`);
                $("#open-box").html(`<div class="text-dark" style="font-size: 1.5em; position: relative; top:0.5em"><ion-icon name="lock-open-outline"></ion-icon></div>`);
            }, 3500);

            // Check the image to gif
            var $this   = $("#loot-box-img"),
                $index  = $this.index(),
                $img    = $this.children('img'),
                $imgSrc = $img.attr('src'),
                $imgAlt = $img.attr('data-alt'),
                $imgExt = $imgAlt.split('.');

            if($imgExt[1] === 'gif') {
                $img.attr('src', $img.data('alt')).attr('data-alt', $imgSrc);
            } else {
                $img.attr('src', $imgAlt).attr('data-alt', $img.data('alt'));
            }

            // Request the server
            $.ajax({
                url: '/action/open-lootbox',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    if (data.success){
                        $("#total-item-text").text("You got " + data.items.length + " item(s)")



                        let list = `<ul class="listview image-listview" style="border-top: 0; border-bottom: 0">`;
                        $.each(data.items, function( index, item ) {
                            let chip;
                            switch(item.rarity){
                                case "Rare":
                                    chip = "chip-danger";
                                    break;
                                case "Common":
                                    chip = "chip-success";
                                    break;
                                case "Super Rare":
                                    chip = "chip-info"
                                    break;
                                case "Legendary":
                                    chip = "chip-warning"
                                    break;
                            }
                            list += `
                            <li>
                                <div class="item">
                                    <img src="${item.image}" alt="image" class="image">
                                    <div class="in">
                                        <div>${item.name}</div>
                                        <div class="chip ${chip} ml-05 mb-05">
                                            <span class="chip-label">${item.rarity}</span>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            `
                        });
                        $("#card-list").html(list + "</ul>")
                    } else {
                        $("#error-dialogue-message").text(data.message)
                        $("#error-dialogue").modal('show');
                    }
                },
                error: function (err){
                    let msg = "Something went wrong, please try again later or get help in game chat.";
                    $("#error-dialogue-message").text(msg)
                    $("#error-dialogue").modal('show');
                }
            });
        });
    </script>
{% endblock %}
